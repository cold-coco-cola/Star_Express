# 分发给任务负责人 — 下一步操作：阶段 2（站点生成与展示）

> **适用对象**：负责「站点生成与展示」的操作任务负责人。  
> **前置条件**：阶段 1 已完成（枚举、GameBalance/LevelConfig/VisualConfig、SolarSystem_01 场景与根节点、第一关 7 站数据已填）。  
> **对应计划**：[星穹铁道实现计划] 阶段 2。  
> **依据**：技术文档 §4.1、§5.1、§5.2、PRD §4.1、计划附录 A.2。

---

## 本步目标与验收

**目标**：按 LevelConfig 在固定位置生成 7 颗星，未解锁站灰显；换 VisualConfig 中 Sprite 可更新显示。

**验收**（计划原文）：

- 运行场景可见 7 颗星在正确坐标：太阳 (0,0)、水星 (1.8,0)、金星 (2.8, 1.6)、地球 (3.8, 0)、火星 (4.2, -1.5)、木星 (5.2, 1.0)、土星 (5.8, -0.8)。
- 未解锁站灰显（开局仅太阳、水星解锁；金星/地球/火星/木星/土星为灰显或半透明）。
- 在 VisualConfig 中替换 shapeSprites 后，站点形状显示可更新（无需改代码）。

**资源需求**：无。可用占位色块或 Unity 内置 2D 图形；若有 4 种形状 Sprite 可放入 Art/Sprites/Stations 并在 VisualConfig 中引用。

---

## 一、创建 StationBehaviour（计划任务 1）

### 1.1 职责与放置位置

- **职责**：持有站点数据；根据 isUnlocked 更新 Visual 的显示（灰显/正常）；供 LevelLoader 注入、后续 UnlockController/乘客生成使用。
- **放置**：`Assets/Game/脚本/Entities/StationBehaviour.cs`。

### 1.2 建议字段（技术文档 §4.1、PRD §4.1）

| 字段名（建议） | 类型 | 说明 |
|----------------|------|------|
| id | string | 关卡内唯一，由 LevelLoader 注入 |
| shapeType | ShapeType | 形状/目的地类型，由 LevelLoader 注入 |
| displayName | string | 显示名（如「水星」），可选 UI |
| isUnlocked | bool | 是否已解锁，开局由 LevelLoader 按 unlockPhase/unlockAfterWeeks 设；后续由 UnlockController 更新 |
| waitingPassengers | List&lt;PassengerBehaviour&gt; | 当前排队乘客（本阶段可仅初始化为空列表） |
| queueCapacity | int | 从 GameBalance 或 LevelConfig.overrides 取，本阶段可用于预留 |
| crowdingThreshold | int | 同上，本阶段可用于预留 |

**position** 由 LevelLoader 写入 **Transform.position**，不必在 Behaviour 中再存一份（若需可加 position 字段便于逻辑用）。

### 1.3 视觉更新（未解锁灰显，计划任务 6）

- 在 StationBehaviour 中取得**子节点 Visual** 的 **SpriteRenderer**（可用 `GetComponentInChildren<SpriteRenderer>()` 或序列化引用）。
- 提供方法如 `RefreshVisual()`：当 `isUnlocked == false` 时，设 `SpriteRenderer.color = Color.gray` 或 `new Color(1f, 1f, 1f, 0.5f)`；当 `isUnlocked == true` 时，设 `Color.white`（或正常亮度）。
- 在数据被 LevelLoader 注入后、以及后续 isUnlocked 被 UnlockController 修改后调用一次 `RefreshVisual()`。

### 1.4 操作步骤

1. 在 `Scripts/Entities` 下创建 **StationBehaviour**，继承 **MonoBehaviour**。
2. 声明上表字段（id, shapeType, displayName, isUnlocked, waitingPassengers 等）；waitingPassengers 在 Awake/Start 中初始化为 `new List<PassengerBehaviour>()`（若尚未有 PassengerBehaviour 类型，可先用 `List<Object>` 或暂不挂乘客逻辑）。
3. 实现 RefreshVisual()，根据 isUnlocked 设置 Visual 的 SpriteRenderer.color。
4. 保存，确保编译通过（PassengerBehaviour 若未创建，waitingPassengers 可先改为 `List<MonoBehaviour>` 或后续阶段再接）。

---

## 二、创建或完善 Station.prefab（计划任务 2）

### 2.1 结构（技术文档 §4.1、03_Prefab与组件）

- **根节点**：命名为 **Station**；挂 **StationBehaviour**、**Collider2D**（如 Circle Collider 2D）。
- **子节点 Visual**：命名为 **Visual**；挂 **SpriteRenderer**（Sprite 可先空或占位）；可预留 Animator 槽位（本阶段可不挂）。

### 2.2 操作步骤

1. 若已有 [03_Prefab与组件](./03_Prefab与组件.md) 中创建的 Station.prefab：在 Prefab 根上 **Add Component → Station Behaviour**（拖入 StationBehaviour 脚本）；确认 Visual 子节点存在且含 SpriteRenderer。
2. 若尚未创建：在 Hierarchy 中 **GameObject → Create Empty** 命名为 Station；添加 **Circle Collider 2D**；创建子节点 **Visual** 并添加 **Sprite Renderer**；根节点添加 **StationBehaviour**；将根拖到 **Assets/Game/预制体/** 生成 **Station.prefab**。
3. Prefab 根 Transform 的 position 保持 (0,0,0)；运行时由 LevelLoader 写入世界坐标。
4. 保存 Prefab。

---

## 三、创建 LevelLoader（计划任务 3）

### 3.1 职责与放置位置

- **职责**：读取 LevelConfig，在场景中 **Stations** 节点下实例化 Station Prefab，并注入 position、shapeType、id、displayName、isUnlocked（开局仅 unlockPhase=="fixed" 且 unlockAfterWeeks==0 的站为 true）。
- **放置**：`Assets/Game/脚本/Core/LevelLoader.cs`。

### 3.2 输入与依赖

- **LevelConfig**：需在运行时传入（如 GameManager 持有 LevelConfig 引用并传给 LevelLoader）。
- **Station Prefab**：需在 LevelLoader 或 GameManager 中配置引用（Inspector 拖入）。
- **父节点**：LevelConfig 中站点的实例化父节点，应为场景中 **Map/Stations** 或 **Stations** 的 Transform（与阶段 1 根节点命名一致）。可通过 `GameObject.Find("Stations")` 或 `GameObject.Find("Map/Stations")` 按实际层级查找，或由 GameManager 传入。

### 3.3 逻辑要点

1. 若 LevelConfig 为 ScriptableObject，遍历 `levelConfig.stations`（或你定义的站点列表字段）。
2. 对每个站点配置项：  
   - `Instantiate(stationPrefab, parent)`，得到实例 `go`。  
   - 设 `go.transform.position = new Vector3(config.position.x, config.position.y, 0)`（或你 LevelConfig 中 position 的类型）。  
   - 取 `go.GetComponent<StationBehaviour>()`，设 `id`、`shapeType`、`displayName`。  
   - **isUnlocked**：若 `unlockPhase == "fixed"` 且 `unlockAfterWeeks == 0` 则为 true，否则 false（阶段二随机池站在阶段 3 再解锁）。  
   - 若有 **VisualConfig** 引用，在此处按 `shapeType` 从 `visualConfig.shapeSprites` 取对应 Sprite 赋给 Visual 的 SpriteRenderer（若 shapeSprites 为数组，则 Circle=0, Triangle=1, Square=2, Star=3；若为 Dictionary 则按枚举键取）。  
   - 调用 `stationBehaviour.RefreshVisual()`。
3. 无 VisualConfig 或 shapeSprites 为空时：可不设 Sprite，仅用 RefreshVisual 做灰显/正常色即可。

### 3.4 操作步骤

1. 在 `Scripts/Core` 下创建 **LevelLoader**（MonoBehaviour 或静态类 + 方法均可）。若为 MonoBehaviour，可挂于 GameManager 同一 GameObject 上。
2. 实现加载方法，签名例如：`public void Load(LevelConfig levelConfig, Transform stationsParent, GameObject stationPrefab, VisualConfig visualConfig)`。
3. 按 3.3 完成实例化与注入；确保 position、shapeType、id、displayName、isUnlocked 与 Visual 的 Sprite（若有）、RefreshVisual 均生效。
4. 保存，编译通过。

---

## 四、创建 GameManager 单例骨架并调用 LevelLoader（计划任务 4）

### 4.1 职责

- 提供单例访问点；在 **Awake** 或 **Start** 中调用 LevelLoader，传入当前关卡 LevelConfig、Stations 父节点、Station prefab、VisualConfig。
- 本阶段不实现周计时、资源发放、失败判定，仅做「加载关卡并生成 7 颗星」。

### 4.2 建议字段（Inspector 配置）

- **LevelConfig**：拖入第一关 LevelConfig 资产（如 SolarSystem_01）。
- **Station Prefab**：拖入 Station.prefab。
- **VisualConfig**：拖入 VisualConfig 资产。
- **Stations Parent**：可留空，代码中通过 `GameObject.Find("Stations")` 或 `GameObject.Find("Map/Stations")` 获取；或在 Inspector 中拖入 Stations 节点。

### 4.3 操作步骤

1. 在 `Scripts/Core` 下创建 **GameManager**，继承 MonoBehaviour。
2. 实现单例（如 `public static GameManager Instance { get; private set; }`，在 Awake 中赋值并可选 DontDestroyOnLoad）。
3. 声明 LevelConfig、Station Prefab、VisualConfig（及可选 Stations Parent）的序列化引用。
4. 在 Start（或 Awake）中：获取 Stations 的 Transform；调用 LevelLoader.Load(levelConfig, stationsTransform, stationPrefab, visualConfig)。
5. 将 **GameManager** 挂到场景中 **GameManager** 根节点上；在 Inspector 中绑定 LevelConfig、Station Prefab、VisualConfig。
6. 若 LevelLoader 为组件，可挂在同一 GameObject，由 GameManager 调用其 Load；或 LevelLoader 为静态方法，直接传参调用。
7. 保存场景与脚本，运行测试。

---

## 五、4 种形状视觉与 VisualConfig 对接（计划任务 5）

### 5.1 约定

- **VisualConfig.shapeSprites**：若为数组，顺序与 ShapeType 枚举一致，例如 `[0]=Circle, [1]=Triangle, [2]=Square, [3]=Star`。LevelLoader 中按 `(int)shapeType` 取 Sprite 赋给 Station 的 Visual 的 SpriteRenderer。
- 若 shapeSprites 为 null 或长度不足：不赋值 Sprite，仅依赖 RefreshVisual 的灰显/正常色；或使用 Unity 内置 2D 图形（如 Sprite.Create 简单占位）保证 7 颗星可见。

### 5.2 操作步骤

1. 在 LevelLoader 注入逻辑中，已按 shapeType 从 VisualConfig.shapeSprites 取 Sprite 并赋给 Visual（见三、3.3）。
2. 若有 4 张形状图，放入 `Art/Sprites/Stations/`，在 VisualConfig 的 shapeSprites 中按顺序拖入 Circle、Triangle、Square、Star。
3. 运行后确认 7 颗星形状与 PRD 3.4.1 一致（太阳/火星=圆，水星/木星=三角，金星/土星=方，地球=星）。

---

## 六、未解锁站灰显（计划任务 6）

### 6.1 实现位置

- 已在 **一、1.3** 的 StationBehaviour.RefreshVisual() 中实现：isUnlocked==false 时 SpriteRenderer.color 灰阶或 alpha 0.5；isUnlocked==true 时正常。

### 6.2 校验

- 开局仅 sun、mercury 为 unlockAfterWeeks==0，应为正常显示；venus、earth、mars、jupiter、saturn 应为灰显或半透明。
- 若某站未灰显，检查 LevelLoader 中 isUnlocked 的赋值逻辑（fixed + unlockAfterWeeks==0 才为 true）。

---

## 七、执行后自检（交回前必做）

请逐项勾选后交付：

- [ ] **StationBehaviour**：已创建，含 id、shapeType、displayName、isUnlocked、waitingPassengers（可空列表）；RefreshVisual() 根据 isUnlocked 设置 Visual 的 SpriteRenderer.color。
- [ ] **Station.prefab**：根节点含 StationBehaviour、Collider2D；子节点 Visual 含 SpriteRenderer；Prefab 位于 _Project/Prefabs。
- [ ] **LevelLoader**：能根据 LevelConfig 在 Stations 下实例化 7 个 Station，注入 position、shapeType、id、displayName、isUnlocked；能从 VisualConfig.shapeSprites 按 shapeType 设置 Sprite（若有）；调用 RefreshVisual()。
- [ ] **GameManager**：单例骨架，Start/Awake 中调用 LevelLoader；Inspector 中已绑定 LevelConfig、Station Prefab、VisualConfig；场景中挂于 GameManager 节点。
- [ ] **验收**：运行 SolarSystem_01 场景，7 颗星出现在正确坐标；太阳、水星正常显示，其余 5 站灰显或半透明；修改 VisualConfig 的 shapeSprites 后重新运行，站点形状可更新。
- [ ] 控制台无报错。

---

## 八、参考与衔接

- **Prefab 结构**：见 [03_Prefab与组件](./03_Prefab与组件.md) Station 部分。
- **场景根节点**：见 [02_场景与根节点](./02_场景与根节点.md)、[分发_下一步操作_阶段1剩余](./分发_下一步操作_阶段1剩余_枚举SO与场景.md) 六。
- **后续阶段**：阶段 3（周计时与站点解锁）将使用 UnlockController 更新 Station.isUnlocked，并依赖 GameManager 周计时。

---

*文档结束。请按上述顺序执行，自检全部勾选后交付。*
