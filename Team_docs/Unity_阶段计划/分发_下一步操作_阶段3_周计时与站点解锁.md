# 分发给任务负责人 — 下一步操作：阶段 3（周计时与站点解锁）

> **适用对象**：负责「周计时与站点解锁」的操作任务负责人。  
> **前置条件**：阶段 2 已完成（7 颗星按 LevelConfig 生成、未解锁站灰显）。  
> **对应计划**：[星穹铁道实现计划] 阶段 3。  
> **依据**：技术文档 §5.1、§5.3、PRD §3.1、§4.1。

---

## 零、站点 Sprite 图片大小统一（保证美观）

在进入阶段 3 逻辑前，建议先统一各站点形状 Sprite 的显示大小，保证 7 颗星在场景中大小一致、美观。

### 0.1 在 Unity 内统一导入尺寸（推荐）

1. **选中站点用图**：在 Project 中进入 **Assets/Game/美术/Sprites/Stations/**，选中用作站点形状的 4 张 Sprite（圆/三角/方/星；若为多张则全选）。
2. **统一 Pixels Per Unit**：在 Inspector 的 **Sprite Editor / Import Settings** 中，将 **Pixels Per Unit (PPU)** 设为同一数值（例如 **100**）。这样 1 世界单位对应的像素数一致，不同图片在相同 Scale 下显示大小一致。
3. **可选：统一 Max Size**：若图片原始分辨率差异大，可统一 **Max Size**（如 256 或 512），避免有的图被压得过小或过大。
4. **Apply**：修改后点击 **Apply**，保存导入设置。

### 0.2 在 Prefab 或运行时统一显示大小

- **方式 A（Prefab）**：打开 **Station.prefab**，选中子节点 **Visual**，在 Transform 中设 **Scale** 为统一值（如 (1, 1, 1)）。若某张 Sprite 原始尺寸差异仍导致视觉大小不同，可对 Visual 的 **SpriteRenderer** 使用 **Draw Mode = Sliced** 并设 **Size**，或微调该站 Visual 的 **Scale**（如 X、Y 乘以同一系数），使 4 种形状在场景中观感一致。
- **方式 B（代码）**：若希望所有站点 Visual 统一世界尺寸，可在 **LevelLoader** 生成 Station 后，根据 VisualConfig 中 Sprite 的 pixelsPerUnit 与目标世界大小，计算并设置 `visual.transform.localScale`，使各站点的 Visual 在世界坐标下占用的范围一致（例如直径约 0.4 单位）。

### 0.3 自检

- 运行场景，7 颗星在场景中**视觉大小一致**、无明显一大一小；未解锁站灰显不变。
- 若使用占位图或内置图形，也建议统一 Station 的 Visual Scale，保证后续换图时习惯一致。

---

## 本步目标与验收

**目标**：周 0 持续 60 秒，周 1 解锁金星，周 2 解锁地球，周 3 起随机池每周 1–2 站；资源发放留阶段 9，本阶段仅做「进入新周」逻辑与解锁。

**验收**（计划原文）：

- 运行 60 秒后金星解锁（由灰显变为正常显示）。
- 运行 120 秒后地球解锁。
- 运行 180 秒起，火星/木星/土星按随机顺序每周解锁 1–2 站，直至 7 站全解锁。

**资源需求**：无。

---

## 一、在 GameManager 中实现周计时（计划任务 1）

### 1.1 逻辑要点

- **周数**：从 0 开始；每累计 **60 秒**（与 GameBalance.weekDurationSeconds 一致）周数 +1。
- **计时方式**：在 GameManager 的 **Update** 中累加 `deltaTime`；当累计值 ≥ 60 秒时，周数 +1，累计值归零（或减去 60），并触发「进入新周」逻辑（本阶段仅执行解锁检查；资源发放留阶段 9）。
- **周 0**：开局即为周 0，计时 60 秒后变为周 1。

### 1.2 建议字段

- `currentWeek`（int）：当前周数，初始 0。
- `weekTimer`（float）：本周已过秒数，每帧 += Time.deltaTime；满 60 秒时 currentWeek++，weekTimer 归零并执行「新周逻辑」。

### 1.3 操作步骤

1. 在 **GameManager** 中增加上述字段；在 **Update** 中累加 weekTimer。
2. 当 `weekTimer >= weekDurationSeconds`（从 GameBalance 读取，默认 60）时：`currentWeek++`；`weekTimer -= weekDurationSeconds`（或归零）；调用「进入新周」逻辑（见二、UnlockController）。
3. 保存，编译通过。

---

## 二、创建 UnlockController（计划任务 2）

### 2.1 职责与放置位置

- **职责**：每周末（进入新周时）执行解锁检查——阶段一按 `unlockAfterWeeks` 解锁；阶段二从 `randomPoolStations` 随机 1–2 站解锁；更新对应 `StationBehaviour.isUnlocked` 并调用 `RefreshVisual()`。
- **放置**：`Assets/Game/脚本/Logic/UnlockController.cs`。可挂于 GameManager 同一 GameObject，或由 GameManager 持有引用并调用其方法。

### 2.2 阶段一（固定节奏，周 0–2）

- 当 `currentWeek >= 某站的 unlockAfterWeeks` 且该站 `unlockPhase == "fixed"` 时，将该站 `isUnlocked` 设为 true。
- 需根据 LevelConfig 的 stations 列表，找到场景中 id 对应的 StationBehaviour，设置其 isUnlocked 并 RefreshVisual()。可约定：LevelLoader 生成后注册到 GameManager 或 UnlockController 的「id → StationBehaviour」字典/列表，供 UnlockController 按 id 查找。

### 2.3 阶段二（随机池，周 3 起）

- 当 `currentWeek >= 3` 时，每周末从 LevelConfig.randomPoolStations 中选出**尚未解锁**的站，随机取 **1–2 站**（`Random.Range(1, 3)` 即 1 或 2）；若池中剩余 ≤ 1 站则全解锁。
- 为每站设置 `isUnlocked = true` 并调用 `RefreshVisual()`。

### 2.4 接口建议

- 方法签名例如：`public void OnWeekAdvanced(int currentWeek, LevelConfig levelConfig, List<StationBehaviour> allStations)` 或由 UnlockController 自己持有 levelConfig 与站点列表引用，仅传入 `currentWeek`。内部根据 currentWeek 执行阶段一/二逻辑。

### 2.5 操作步骤

1. 在 **Scripts/Logic** 下创建 **UnlockController**（MonoBehaviour 或纯 C# 类均可）。
2. 实现阶段一：遍历 LevelConfig.stations，若 unlockPhase=="fixed" 且 currentWeek >= unlockAfterWeeks，则按 id 找到对应 StationBehaviour，设 isUnlocked=true，RefreshVisual()。
3. 实现阶段二：若 currentWeek >= 3，从 randomPoolStations 中筛出未解锁站，随机 1–2 个（或 min(随机数, 剩余数)），设 isUnlocked=true，RefreshVisual()。
4. 确保 LevelLoader/GameManager 在生成站点后，有方式让 UnlockController 按 id 找到 StationBehaviour（例如 GameManager 维护 `Dictionary<string, StationBehaviour>`，LevelLoader 生成时注册）。

---

## 三、周 0 不发放资源；满一周时触发「进入新周」逻辑（计划任务 3、4）

### 3.1 周 0 不发放资源

- 本阶段**不实现**资源发放（shipCount、客舱/星隧等），仅实现「满 60 秒周数 +1」与「每周末执行解锁」。
- 在 GameManager 的「进入新周」分支中，**仅调用 UnlockController**；资源发放、本周奖励弹窗留阶段 9。

### 3.2 每周末执行解锁

- 在 GameManager 中，当 `weekTimer >= weekDurationSeconds` 并执行 currentWeek++ 后，**立即调用** UnlockController 的解锁逻辑（传入 currentWeek 或由 UnlockController 读取 GameManager.currentWeek），更新各站 isUnlocked 并 RefreshVisual()。

### 3.3 操作步骤

1. 在 GameManager 的「满一周」处理中，先 `currentWeek++`、weekTimer 归零，再调用 `UnlockController.OnWeekAdvanced(...)`（或等价方法）。
2. 不添加资源计数与发放代码；验收时仅验证解锁节奏正确。

---

## 四、执行后自检（交回前必做）

请逐项勾选后交付：

- [ ] **零、站点 Sprite**：4 种站点形状 Sprite 的 Pixels Per Unit 已统一（或 Visual Scale 已统一）；运行场景 7 颗星视觉大小一致、美观。
- [ ] **周计时**：GameManager 中周数随 60 秒递增；周 0 持续 60 秒后变为周 1。
- [ ] **UnlockController**：阶段一：60 秒后金星解锁，120 秒后地球解锁；阶段二：180 秒起火星/木星/土星按随机顺序每周 1–2 站解锁。
- [ ] **灰显/正常**：未解锁站灰显，解锁后变为正常显示（RefreshVisual 生效）。
- [ ] 本阶段未实现资源发放与本周奖励 UI；控制台无报错。

---

## 五、参考与衔接

- **LevelConfig 结构**：randomPoolStations、randomUnlockPerWeek、stations[].unlockPhase / unlockAfterWeeks，见 PRD 3.4.6、阶段 1 分发文档。
- **StationBehaviour**：isUnlocked、RefreshVisual()，见阶段 2 分发文档。
- **后续阶段**：阶段 9 实现资源发放与本周奖励弹窗；本阶段仅做周计时与解锁。

---

*文档结束。请先完成「零、站点 Sprite 大小统一」，再按一～三执行，自检全部勾选后交付。*
