# 分发给任务负责人 — 下一步操作：阶段 4（连线与延伸）

> **适用对象**：负责「连线与延伸」的操作任务负责人。  
> **前置条件**：阶段 3 已完成（周计时、站点按节奏解锁）。  
> **对应计划**：[星穹铁道实现计划] 阶段 4。  
> **依据**：技术文档 §4.3、§5.2、§5.4、§10.2、PRD §6.1。

---

## 本步目标与验收

**目标**：点击两站建线或延伸，3 色选色，同色仅一条线；航线用 LineRenderer 绘制，颜色由 Line.color 决定。

**验收**（计划原文）：

- 可建太阳–水星线，可选红/绿/蓝。
- 可延伸至金星、地球等（延伸仅限该线首站或末站）。
- 选色取消后清除第一站高亮、退出建线模式，不建线。

**资源需求**：无。航线颜色从 VisualConfig.lineColors 取（或与 LineColor 枚举对应）。

---

## 一、创建 Line 数据类（计划任务 1）

### 1.1 职责与放置位置

- **职责**：纯数据，无 GameObject；存 color、stationSequence、ships；建线/延伸时由 LineManager 修改 stationSequence。
- **放置**：`Assets/Game/脚本/Entities/Line.cs`（或 Core，与项目约定一致）。

### 1.2 建议字段（技术文档 §4.3）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | string | 唯一标识，如 "Line_0"、"Line_1"，便于多船同站排序 |
| color | LineColor 或 Color | 航线颜色 |
| stationSequence | List&lt;StationBehaviour&gt; | 站点顺序，相邻即一段；建线为 [A,B]，延伸在首端或末端插入 |
| ships | List&lt;ShipBehaviour&gt; | 本线上的船（本阶段可空列表，阶段 5 再用） |
| segmentsPendingRemoval | List&lt;(Station,Station)&gt; 或可空 | 首版可空或 null；取消航线扩展预留 |

### 1.3 操作步骤

1. 在 **Scripts/Entities**（或 Core）下创建 **Line.cs**，定义为普通 C# 类（不继承 MonoBehaviour）。
2. 声明上述字段；构造函数或工厂方法中初始化 stationSequence、ships 为空列表，id 由 LineManager 分配。
3. 保存，编译通过。

---

## 二、创建 LineManager（计划任务 2）

### 2.1 职责与放置位置

- **职责**：维护 Line 列表；根据玩家选色结果执行「新建 Line」或「延伸已有 Line」；为每条 Line 创建并更新视觉（LineRenderer）；同色仅一条线、同色 A–B 不重复、延伸仅限端点等规则在此实现。
- **放置**：`Assets/Game/脚本/Core/LineManager.cs`（或挂 Map 节点）。可挂 GameManager 或 Map，需能访问 Lines 根节点以挂载 Line 视觉 GameObject。

### 2.2 新建与延伸逻辑（PRD 6.1）

- **新建**：若当前不存在 color 为 C 的 Line，则创建新 Line：id 自增（如 Line_0）、color=C、stationSequence=[A, B]、ships=[]；并创建该 Line 的视觉（见 2.4）。
- **延伸**：若已存在 color 为 C 的 Line L，且 A 或 B 是 L.stationSequence 的**首站**或**末站**：  
  - 首站为 A → 首端插入 B，得 [B, A, …]；首站为 B → 首端插入 A，得 [A, B, …]。  
  - 末站为 A → 末端追加 B，得 […, A, B]；末站为 B → 末端追加 A，得 […, B, A]。  
  - 延伸后更新该 Line 的 LineRenderer 顶点。
- **不允许**：A、B 为同一点；已存在「颜色 C 且含相邻 A–B」的 Line；已存在颜色 C 的 Line 且 A、B 均非其端点（此时应提示或返回失败，由调用方弹提示）。

### 2.3 接口建议

- `public bool TryCreateOrExtendLine(StationBehaviour stationA, StationBehaviour stationB, LineColor color)`  
  - 返回 true 表示成功建线/延伸；false 表示不满足条件（同点、同色重复段、A/B 非端点等），调用方可根据返回值决定是否提示。
- 内部维护 `List<Line> lines` 与 id 计数器；需引用 **Lines** 根 Transform（或 Map），用于实例化/挂载每条 Line 的视觉 GameObject。

### 2.4 航线视觉（计划任务 5；技术文档 §4.3、§10.1）

- 每条 Line 对应一个 **GameObject**（可命名为 "Line_视觉_0" 等），挂在该 Line 的 id 下或 Lines 根下。
- 在该 GameObject 上添加 **LineRenderer**：  
  - **Position Count** = stationSequence.Count；**SetPosition(i, stationSequence[i].transform.position)**（或 Vector3(x,y,0)）。  
  - **宽度**：约 0.1～0.15 单位（技术文档 §10.1）；**颜色**：从 VisualConfig.lineColors 按 Line.color 取，或直接使用 LineColor 映射的 Color。  
  - **Material**：使用 Unity 2D 默认或 Unlit 材质，保证可见；**Loop** = false。  
- 新建/延伸后立即更新该 Line 的 LineRenderer 的 positionCount 与 SetPosition，使折线正确连接 A–B 或整条 stationSequence。

### 2.5 操作步骤

1. 在 **Scripts/Core** 下创建 **LineManager**（MonoBehaviour），挂到 GameManager 或 Map。
2. 声明 lines 列表、Lines 根 Transform 引用（或 Find("Lines")）、VisualConfig 引用（取 lineColors）；实现 TryCreateOrExtendLine(A, B, color)。
3. 在 TryCreateOrExtendLine 内实现新建/延伸逻辑，并为每条 Line 创建/更新 LineRenderer 视觉。
4. 保存，编译通过。

---

## 三、创建 LineDrawingInput（计划任务 3）

### 3.1 职责与放置位置

- **职责**：检测点击站点；第一击选站 A 并高亮，第二击选站 B 后弹出选色面板；选色后调用 LineManager.TryCreateOrExtendLine；选色取消则清除 A 高亮并退出建线模式。仅对 **isUnlocked** 的站响应。
- **放置**：`Assets/Game/脚本/Input/LineDrawingInput.cs`。挂 Map 或 Main Camera，需能做 2D 射线检测或 OverlapPoint。

### 3.2 状态与流程

- **状态**：Idle（无选中）、FirstSelected（已选 A，等待选 B）。
- **Idle**：点击某站且 isUnlocked → 设为 A，进入 FirstSelected，A 高亮（如 SpriteRenderer.color 加亮或子节点高亮）。
- **FirstSelected**：  
  - 点击 B 且 B≠A 且 B.isUnlocked → 弹出选色面板（3 色 + 取消）；玩家选色 C → 调用 LineManager.TryCreateOrExtendLine(A, B, C)，成功则清除高亮、回到 Idle；失败则提示并保持 FirstSelected 或回到 Idle。  
  - 点击 A 或空白或选色面板「取消」→ 清除 A 高亮，回到 Idle。
- 高亮方式：在 StationBehaviour 或本脚本中设置 A 的 Visual 的 SpriteRenderer.color 临时加亮，取消时恢复 RefreshVisual()。

### 3.3 操作步骤

1. 在 **Scripts/Input** 下创建 **LineDrawingInput**，继承 MonoBehaviour。
2. 实现点击检测（如 Camera.ScreenToWorldPoint + Physics2D.OverlapPoint 或 RaycastHit2D，过滤 Layer 或 Tag 为站点）；根据当前状态执行选 A、选 B 弹选色、取消逻辑。
3. 选色面板由 UI 层提供（见四）；本脚本只需在「选 B 后」显示面板并注册「选色 C」与「取消」回调，在回调中调用 LineManager 或清除高亮。
4. 保存，编译通过。

---

## 四、选色面板 Overlay（计划任务 4）

### 4.1 要求（PRD 6.1、技术文档 §10.2、UI 文档 §3.3、§7）

- **时机**：玩家点击第二站 B 后弹出。
- **内容**：3 色按钮（红/绿/蓝，与 LineColor 或 VisualConfig.lineColors 一致）+ **取消**按钮。
- **选色**：点击某色 → 关闭面板，通知 LineDrawingInput 执行建线/延伸，然后清除第一站高亮。
- **取消**：点击取消或关闭 → 清除第一站高亮、退出建线模式，不建线。

### 4.2 实现方式

- 在 **Canvas** 下创建 Overlay 层（或使用现有 Overlay），添加 **选色面板** Panel：3 个 Button（红/绿/蓝）+ 1 个「取消」Button；Panel 默认隐藏，需要时 SetActive(true)。
- LineDrawingInput 在「选 B」后调用显示选色面板，并传入回调：OnColorSelected(LineColor color)、OnCancel()。面板在 OnColorSelected 时关闭并调用回调；OnCancel 时关闭并调用取消回调。
- 若尚未有 UI 文档中的详细规格，可先做简单 Panel + 4 个 Button，按钮文字或颜色与 Red/Green/Blue、取消对应即可。

### 4.3 操作步骤

1. 在场景 Canvas 下创建选色面板 GameObject（如 ColorPickPanel）；添加 3 个颜色按钮 + 1 个取消按钮；Panel 默认 inactive。
2. 编写简单 UI 脚本（如 ColorPickPanelUI）：Show(A, B, onSelected, onCancel)；OnSelected 传入 LineColor，onCancel 无参。LineDrawingInput 在选 B 后调用 Show，在 onSelected 中调用 LineManager.TryCreateOrExtendLine(A, B, color) 并清除高亮，在 onCancel 中仅清除高亮。
3. 保存场景与 Prefab（若选色面板做成 Prefab 则放入 Prefabs/UI）。

---

## 五、航线视觉与边界（计划任务 5、6）

### 5.1 LineRenderer 规范

- 宽度 0.1～0.15 单位；首版不做圆角；整条线按 stationSequence 一次性绘制；颜色由 Line.color 决定（VisualConfig.lineColors）。
- 可选：选中/悬停时宽度×1.2 或高亮（本阶段可不做，阶段 5 放置飞船时再考虑点击检测）。

### 5.2 边界与提示

- **同色 A–B 不重复**：LineManager.TryCreateOrExtendLine 内若已存在颜色 C 且 stationSequence 中含相邻 A–B，返回 false；LineDrawingInput 或选色面板处可弹简单提示（如 Debug.Log 或 UI Text）。
- **延伸仅限端点**：若存在颜色 C 的 Line 但 A、B 均非其首站或末站，返回 false，提示「请选择其他颜色，或将新站连到现有线路端点」。
- **A、B 为同一点**：在 LineDrawingInput 中若 B==A，可不弹选色，直接视为取消或忽略。

### 5.3 操作步骤

1. 在二、2.4 中已实现 LineRenderer 创建与更新；确认宽度与颜色符合文档。
2. 在 LineManager 与 LineDrawingInput 中落实上述边界判断与提示；选色取消后第一站高亮清除。

---

## 六、执行后自检（交回前必做）

请逐项勾选后交付：

- [ ] **Line**：数据类含 id、color、stationSequence、ships；无 GameObject。
- [ ] **LineManager**：维护 Line 列表；TryCreateOrExtendLine 正确实现新建与延伸；同色仅一条线、同色 A–B 不重复、延伸仅端点；每条 Line 有对应 LineRenderer，按 stationSequence 绘制，颜色与宽度正确。
- [ ] **LineDrawingInput**：点击 A 高亮、点击 B 弹选色；选色后建线/延伸并清除高亮；选色取消或点击 A/空白清除高亮。
- [ ] **选色面板**：3 色 + 取消；选色执行建线/延伸，取消退出建线模式。
- [ ] **验收**：可建太阳–水星线并选红/绿/蓝；可延伸至金星、地球等；选色取消后高亮清除、不建线。
- [ ] 控制台无报错。

---

## 七、参考与衔接

- **建线/延伸规则**：PRD §6.1、技术文档 §10.2。
- **Line 与视觉**：技术文档 §4.3、§10.1。
- **后续阶段**：阶段 5 将在 Line 上放置飞船，并需点击 Line 检测（可沿用 LineRenderer 所在 GameObject 加 Collider2D 或射线检测）。

---

*文档结束。请按一～五顺序执行，自检全部勾选后交付。*
