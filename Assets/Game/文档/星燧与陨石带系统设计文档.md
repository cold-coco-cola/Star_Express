# 星燧与陨石带系统设计文档

> 版本：1.0  
> 更新日期：2026-03-01

---

## 一、概念定义

### 1.1 星燧（StarTunnel）

| 属性 | 说明 |
|------|------|
| 类型 | 消耗性资源 |
| 用途 | 建设穿越陨石带的线路 |
| 获取 | 周奖励轮转发放（客舱→星燧→客舱→星燧...） |
| 存储 | `LineManager._starTunnelStock` |
| 显示 | `StarTunnelPanel` 显示当前存量 |

### 1.2 陨石带（AsteroidBelt）

| 属性 | 说明 |
|------|------|
| 类型 | 地图障碍物 |
| 形状 | 折线带状区域（可手动编辑） |
| 作用 | 线路穿越时消耗星燧资源 |
| 视觉 | 随机分布的陨石 Sprite |
| 层级 | 站点下层 |

### 1.3 穿越定义

```
穿越 = 线路段与陨石带区域相交

    站点A ●────────────● 站点B
              │
    ═════════╪═════════  陨石带
              │
          穿越区域
```

---

## 二、世界单位参考

| 物体 | 尺寸（世界单位） | 代码位置 |
|------|------------------|----------|
| 飞船碰撞器半径 | 0.6 | `ShipBehaviour.cs:75` |
| 航线宽度 | 0.1 | `LineManager.cs:739` |
| 站点点击检测半径 | 0.6 | `LineDrawingInput.cs:273` |
| 站点间距离 | 4~6 | `LevelConfig.spawnDistanceMin/Max × 1.8` |
| **陨石带建议带宽** | **0.8~1.5** | 约 1~2.5 个飞船直径 |
| **陨石大小** | **0.1~0.3** | 约 1/6~1/2 个飞船直径 |
| **陨石间距** | **0.3~0.5** | 高密度分布 |

---

## 三、数据结构

### 3.1 Line 类扩展

```csharp
// Line 类新增字段
public List<int> segmentStarTunnelCosts = new List<int>();

// 说明：
// - 记录每个线段消耗的星燧数量
// - 索引与 stationSequence 对应
// - stationSequence 有 N 个站点，则有 N-1 个线段

// 示例：
// 站点：A ─── B ─── C ─── D
// 索引：  0     1     2
// 
// segmentStarTunnelCosts = [0, 1, 0]
//                          │  │  │
//                          │  │  └─ 段2（C-D）不穿越
//                          │  └──── 段1（B-C）穿越陨石带
//                          └─────── 段0（A-B）不穿越
```

### 3.2 AsteroidBeltBehaviour 组件

```csharp
// 组件名称：AsteroidBeltBehaviour
// 挂载位置：陨石带游戏对象

[Header("路径定义")]
public Transform pathContainer;     // 指向 Path 子对象
public float width = 1.0f;          // 带宽

[Header("穿越设置")]
public int crossCost = 1;           // 每次穿越消耗的星燧数量

[Header("调试")]
public bool showGizmos = true;      // Scene 视图显示碰撞区域

// 公共方法
public int GetCrossCount(Vector2 a, Vector2 b);
// 返回线段 AB 穿越本陨石带的次数
```

### 3.3 LineManager 扩展

```csharp
// LineManager 新增方法
public int GetTotalCrossCount(Vector2 a, Vector2 b)
{
    // 1. 查找场景中所有 AsteroidBeltBehaviour
    // 2. 遍历每条陨石带，调用 GetCrossCount
    // 3. 处理相交陨石带的重叠区域
    // 4. 返回总穿越次数
}
```

---

## 四、陨石带视觉效果

### 4.1 整体视觉风格

| 元素 | 规范 |
|------|------|
| **主体** | 不使用颜色填充，仅通过陨石 Sprite 分布显示 |
| **陨石** | 小型不规则形状 Sprite，高密度随机分布 |
| **边缘** | 无特殊边缘效果，由陨石自然形成边界 |
| **层级** | Sorting Layer 在站点下层 |

### 4.2 陨石 Sprite 要求

| 属性 | 规范 |
|------|------|
| 形状 | 不规则多边形、圆形、椭圆形 |
| 颜色 | 深灰、棕色、暗紫色（与背景协调） |
| 数量 | 准备 3~5 种不同形状的 Sprite |
| 尺寸 | Sprite 原始尺寸 32×32 或 64×64 像素 |

### 4.3 陨石分布规范

```
带宽 1.0 世界单位内的陨石分布示例：

    ○  ○    ○  ○
  ○    ○  ○    ○    ○
    ○    ○    ○  ○
  ○  ○    ○  ○    ○
    ○  ○    ○

分布要求：
├── 密度：高密度，每 0.3~0.5 世界单位一个
├── 大小：随机 0.1~0.3 世界单位
├── 角度：随机旋转 0°~360°
├── 位置：在带宽范围内，略微偏离中心线
└── 重叠：允许轻微重叠，增加密集感
```

### 4.4 层级设置

```
层级结构（Z 值，越小越靠前）：

Background    Z=10   背景星空
AsteroidBelt  Z=5    陨石带 ← 新增
Lines         Z=1    航线
Stations      Z=0    站点
Ships         Z=-1   飞船
Passengers    Z=-2   乘客
```

### 4.5 穿越段线路视觉

```
正常线路：══════════════════════════════
穿越段：  ════╌╌╌╌╌╌╌╌╌╌══════════════
              ↑ 虚线段

虚线规范：
├── 样式：简单虚线
├── 颜色：与原线路颜色一致
├── 间隔：0.1 实线 + 0.05 空白
└── 无需动画效果
```

---

## 五、陨石带可视化编辑

### 5.1 游戏对象结构

```
Map
└── AsteroidBelts                    ← 陨石带根节点
    ├── AsteroidBelt_01              ← 第一条陨石带
    │   ├── Path                     ← 路径定义
    │   │   └── LineRenderer         ← 折线路径（手动编辑位置点）
    │   │
    │   ├── Asteroids                ← 陨石群容器
    │   │   ├── Asteroid_01          ← SpriteRenderer
    │   │   ├── Asteroid_02
    │   │   └── ...（手动放置）
    │   │
    │   └── AsteroidBeltBehaviour    ← 碰撞检测组件
    │
    └── AsteroidBelt_02              ← 第二条陨石带
        └── ...
```

### 5.2 编辑流程

| 步骤 | 操作 |
|------|------|
| 1 | 在 Hierarchy 创建空对象 `AsteroidBelt_01` |
| 2 | 添加 `AsteroidBeltBehaviour` 组件 |
| 3 | 创建子对象 `Path`，添加 `LineRenderer` |
| 4 | 手动调整 LineRenderer 的 Position 点定义折线路径 |
| 5 | 创建子对象 `Asteroids` |
| 6 | 在 `Asteroids` 下创建陨石 Sprite（手动放置） |
| 7 | 设置 `width` 参数 |
| 8 | 设置 Sorting Layer（站点下层） |

### 5.3 LineRenderer 配置

| 属性 | 建议值 |
|------|--------|
| Width | 0.05（仅用于编辑时可视化） |
| Color | 半透明灰色（编辑时可见，运行时可隐藏） |
| Positions | 手动添加路径点，定义折线形状 |

### 5.4 陨石放置操作

```
手动放置陨石：

1. 准备陨石 Sprite 资源
   - 路径：美术/Sprites/Asteroids/
   - 文件：asteroid_01.png, asteroid_02.png, ...

2. 创建陨石对象
   - 在 Asteroids 下创建空对象
   - 添加 SpriteRenderer 组件
   - 选择陨石 Sprite

3. 调整位置
   - 使用 Transform 工具拖拽
   - 确保在带宽范围内

4. 调整大小和角度
   - Scale：0.1~0.3 世界单位
   - Rotation：随机角度

5. 复制填充
   - Ctrl+D 复制陨石对象
   - 拖拽到新位置
   - 调整大小和角度
   - 重复直到密度满意
```

---

## 六、穿越检测算法

### 6.1 单条陨石带检测

```csharp
// AsteroidBeltBehaviour.GetCrossCount(Vector2 a, Vector2 b) → int

算法流程：
1. 从 LineRenderer 读取路径点 → List<Vector2> pathPoints
2. 遍历每段折线：
   for i = 0 to pathPoints.Count - 2:
       Vector2 p1 = pathPoints[i]
       Vector2 p2 = pathPoints[i+1]
       
       // 将折线段扩展为有向矩形（带宽）
       Rect beltRect = ExpandToRect(p1, p2, width)
       
       // 检测线段 AB 与矩形是否相交
       if (LineIntersectsRect(a, b, beltRect)):
           crossCount++
           
3. 返回 crossCount
```

### 6.2 全局检测

```csharp
// LineManager.GetTotalCrossCount(Vector2 a, Vector2 b) → int

算法流程：
1. 查找所有陨石带：
   var allBelts = FindObjectsOfType<AsteroidBeltBehaviour>()
   
2. 遍历检测：
   int totalCross = 0
   foreach (belt in allBelts):
       totalCross += belt.GetCrossCount(a, b)
       
3. 处理相交陨石带：
   - 如果两条陨石带相交
   - 且线路同时穿越相交区域
   - 只计 1 次（避免重复计算）
   
4. 返回 totalCross
```

### 6.3 线段-矩形相交检测

```csharp
// LineIntersectsRect(Vector2 a, Vector2 b, Rect rect) → bool

可用方法：
- Cohen-Sutherland 算法
- 分离轴定理（SAT）
- 简化方法：检测端点 + 中点是否在矩形内
```

---

## 七、建设线路逻辑

### 7.1 新建线路

```
TryCreateOrExtendLine(stationA, stationB, color) → bool

流程：
1. 常规检查
   ├─ 站点有效性
   ├─ 线路数量上限（_maxLineCount）
   └─ 飞船存量（_shipStock >= 1）
   
2. 检测穿越陨石带
   crossCount = GetTotalCrossCount(
       stationA.transform.position,
       stationB.transform.position
   )
   
3. 检查星燧存量
   if (_starTunnelStock < crossCount):
       显示提示："星燧不足，无法穿越陨石带"
       return false
       
4. 扣除资源
   _shipStock -= 1
   _starTunnelStock -= crossCount
   
5. 创建线路
   line = new Line("Line_" + id, color)
   line.stationSequence.Add(stationA)
   line.stationSequence.Add(stationB)
   line.segmentStarTunnelCosts.Add(crossCount)  // 记录该段消耗
   
6. 生成飞船
   SpawnShip(line, consumeStock: false)  // 已手动扣除
   
7. 刷新视觉
   CreateOrUpdateLineRenderer(line)
   
8. return true
```

### 7.2 延伸线路

```
TryCreateOrExtendLine(existingLine, newStation) → bool

流程：
1. 确定延伸端点
   - 若 newStation 接近首站 → 向前延伸
   - 若 newStation 接近末站 → 向后延伸
   
2. 检测新增线段的穿越次数
   crossCount = GetTotalCrossCount(
       endpoint.transform.position,
       newStation.transform.position
   )
   
3. 检查星燧存量
   if (_starTunnelStock < crossCount):
       显示提示："星燧不足，无法穿越陨石带"
       return false
       
4. 扣除星燧
   _starTunnelStock -= crossCount
   
5. 延伸线路
   if (向前延伸):
       line.stationSequence.Insert(0, newStation)
       line.segmentStarTunnelCosts.Insert(0, crossCount)
   else:
       line.stationSequence.Add(newStation)
       line.segmentStarTunnelCosts.Add(crossCount)
   
6. 刷新视觉
   CreateOrUpdateLineRenderer(existingLine)
   
7. return true
```

### 7.3 形成环形

```
TryCreateOrExtendLine(形成环形) → bool

流程：
1. 检测闭合段的穿越次数
   crossCount = GetTotalCrossCount(
       末站.transform.position,
       首站.transform.position
   )
   
2. 检查星燧存量
   if (_starTunnelStock < crossCount):
       显示提示："星燧不足，无法穿越陨石带"
       return false
       
3. 扣除星燧
   _starTunnelStock -= crossCount
   
4. 闭合线路
   existingLine.stationSequence.Add(首站)  // 形成环
   existingLine.segmentStarTunnelCosts.Add(crossCount)  // 记录闭合段消耗
   
5. 刷新视觉
   CreateOrUpdateLineRenderer(existingLine)
   
6. return true
```

---

## 八、删除线路逻辑

### 8.1 核心原则

```
┌─────────────────────────────────────────────────────────┐
│              对称原则：消耗 = 返还                       │
├─────────────────────────────────────────────────────────┤
│  建设某段时：                                            │
│    - 检测穿越次数 → 扣除星燧 → 记录到该段                │
│                                                         │
│  删除某段时：                                            │
│    - 读取该段记录 → 返还星燧                             │
└─────────────────────────────────────────────────────────┘
```

### 8.2 删除末端段

```
TryRemoveEndSegment(line, segmentIndex) → bool

前提：segmentIndex 必须是端点段（0 或 最后一段）

流程：
1. 读取该段的星燧消耗
   costToReturn = line.segmentStarTunnelCosts[segmentIndex]
   
2. 返还星燧
   _starTunnelStock += costToReturn
   
3. 删除站点
   if (segmentIndex == 0):
       line.stationSequence.RemoveAt(0)
       line.segmentStarTunnelCosts.RemoveAt(0)
   else:
       line.stationSequence.RemoveAt(lastIndex)
       line.segmentStarTunnelCosts.RemoveAt(lastSegmentIndex)
       
4. 更新飞船位置
   调整该线路上飞船的 currentSegmentIndex
   
5. 检查线路是否仍有 >= 2 站
   if (line.stationSequence.Count < 2):
       RemoveLine(line)  // 删除整条线路
   else:
       刷新视觉
       
6. return true
```

### 8.3 删除整条线路

```
RemoveLine(line)

流程：
1. 计算总星燧消耗
   totalCost = line.segmentStarTunnelCosts.Sum()
   
2. 返还星燧
   _starTunnelStock += totalCost
   
3. 返还飞船
   _shipStock += line.ships.Count
   
4. 销毁飞船对象
   foreach (ship in line.ships):
       Destroy(ship.gameObject)
       
5. 清空数据
   line.ships.Clear()
   line.stationSequence.Clear()
   line.segmentStarTunnelCosts.Clear()
   
6. 移除线路
   _lines.Remove(line)
   
7. 销毁视觉对象
   Destroy(Line_视觉_{line.id})
```

### 8.4 环形线路删除段

```
TryRemoveLoopSegment(line, segmentIndex) → bool

流程：
1. 读取该段的星燧消耗
   costToReturn = line.segmentStarTunnelCosts[segmentIndex]
   
2. 返还星燧
   _starTunnelStock += costToReturn
   
3. 打破环形
   - 移除闭合站
   - 重排站点序列
   - 移除对应的 segmentStarTunnelCosts
   
4. 线路变为普通线路
   刷新视觉
```

---

## 九、对称逻辑对照表

| 操作 | 消耗逻辑 | 返还逻辑 |
|------|----------|----------|
| **新建线路** | 检测 AB 段穿越次数 → 扣除 → `segmentStarTunnelCosts[0] = crossCount` | 删除该段 → 读取 `segmentStarTunnelCosts[0]` → 返还 |
| **延伸线路（向后）** | 检测新增段穿越次数 → 扣除 → `segmentStarTunnelCosts.Add(crossCount)` | 删除末段 → 读取最后元素 → 返还 |
| **延伸线路（向前）** | 检测新增段穿越次数 → 扣除 → `segmentStarTunnelCosts.Insert(0, crossCount)` | 删除首段 → 读取第一个元素 → 返还 |
| **形成环形** | 检测闭合段穿越次数 → 扣除 → `segmentStarTunnelCosts.Add(crossCount)` | 打破环形 → 读取对应元素 → 返还 |
| **删除整线** | — | 读取所有元素求和 → 返还 |

---

## 十、相交陨石带处理

### 10.1 场景

```
两条陨石带相交：

    陨石带A ═══════════
              ╳ 相交区域
    陨石带B ═══════════
```

### 10.2 处理规则

```
线路穿过相交区域：
- 检测陨石带A：穿越 1 次
- 检测陨石带B：穿越 1 次
- 实际消耗：1 星燧（不是 2）

实现方式：
- 检测时记录穿越的具体区域（矩形范围）
- 如果两次穿越的区域重叠，只计 1 次
```

### 10.3 用户手动调整

- 相交问题由用户在编辑时手动调整
- 避免不必要的相交
- 如果相交是设计意图，系统自动处理重叠

---

## 十一、UI 反馈

### 11.1 建线提示

| 场景 | 提示方式 |
|------|----------|
| 星燧不足 | Toast："星燧不足，无法穿越陨石带" |
| 穿越预览 | 拖拽时显示虚线 + 星燧图标 + 消耗数量 |

### 11.2 删线提示

| 场景 | 提示方式 |
|------|----------|
| 返还星燧 | Toast："返还星燧 ×N" |
| 返还动画 | StarTunnelPanel 显示 +N 动画 |

### 11.3 存量显示

| 组件 | 显示内容 |
|------|----------|
| StarTunnelPanel | 当前星燧存量数字 |
| StarTunnelHintPopup | 说明："建设线路穿过陨石带时，会自动直接消耗星燧资源" |

---

## 十二、代码修改清单

| 文件 | 修改内容 |
|------|----------|
| **Line.cs** | 新增 `segmentStarTunnelCosts: List<int>` |
| **LineManager.cs** | 新增 `GetTotalCrossCount()` 方法 |
| **LineManager.cs** | `TryCreateOrExtendLine()` 增加穿越检测和星燧扣除 |
| **LineManager.cs** | `TryRemoveEndSegment()` 增加星燧返还 |
| **LineManager.cs** | `RemoveLine()` 增加星燧返还 |
| **LineManager.cs** | `CreateOrUpdateLineRenderer()` 增加虚线处理 |
| **AsteroidBeltBehaviour.cs** | 新建组件，实现穿越检测 |
| **StarTunnelPanel.cs** | 增加返还动画（可选） |

---

## 十三、文件结构

```
Assets/Game/
├── 脚本/
│   ├── Core/
│   │   ├── LineManager.cs           ← 修改
│   │   └── Line.cs                  ← 修改
│   │
│   ├── Entities/
│   │   └── AsteroidBeltBehaviour.cs ← 新建
│   │
│   └── UI/
│       ├── StarTunnelPanel.cs       ← 可选修改
│       └── StarTunnelHintPopup.cs   ← 已存在
│
├── 美术/
│   └── Sprites/
│       └── Asteroids/                ← 新建文件夹
│           ├── asteroid_01.png       ← 陨石 Sprite
│           ├── asteroid_02.png
│           └── ...
│
├── 预制体/
│   └── AsteroidBelt.prefab          ← 可选预制体
│
└── 场景/
    └── SolarSystem_01.unity         ← 放置陨石带对象
```

---

## 十四、实现优先级

| 优先级 | 任务 | 依赖 |
|--------|------|------|
| P0 | Line 类新增 `segmentStarTunnelCosts` | 无 |
| P0 | AsteroidBeltBehaviour 组件 | 无 |
| P0 | 穿越检测算法 | AsteroidBeltBehaviour |
| P0 | 建线时消耗星燧 | 穿越检测 |
| P0 | 删线时返还星燧 | segmentStarTunnelCosts |
| P1 | 穿越段虚线显示 | segmentStarTunnelCosts |
| P1 | UI 反馈优化 | 无 |
| P2 | 相交陨石带重叠处理 | 穿越检测 |

---

## 十五、测试用例

### 15.1 基础功能测试

| 测试项 | 预期结果 |
|--------|----------|
| 建线不穿越陨石带 | 不消耗星燧 |
| 建线穿越 1 条陨石带 | 消耗 1 星燧 |
| 建线穿越同 1 条陨石带 2 次 | 消耗 2 星燧 |
| 建线穿越 2 条不同陨石带 | 消耗 2 星燧 |
| 星燧不足时建线 | 拒绝，显示提示 |

### 15.2 资源返还测试

| 测试项 | 预期结果 |
|--------|----------|
| 删除不穿越陨石带的线路 | 返还 0 星燧 |
| 删除穿越陨石带的线路 | 返还对应数量星燧 |
| 删除末端段（线路仍存在） | 返还该段消耗的星燧 |
| 删除末端段（线路被移除） | 返还全部星燧 |

### 15.3 视觉测试

| 测试项 | 预期结果 |
|--------|----------|
| 陨石带显示 | 高密度陨石 Sprite 分布 |
| 穿越段线路 | 显示为虚线 |
| 非穿越段线路 | 显示为实线 |

---

## 十六、附录

### 16.1 陨石 Sprite 制作建议

1. **尺寸**：32×32 或 64×64 像素
2. **形状**：不规则多边形，边缘粗糙
3. **颜色**：深灰 (#3A3A3A)、棕色 (#4A3A2A)、暗紫 (#3A2A3A)
4. **数量**：3~5 种不同形状
5. **格式**：PNG，带透明通道

### 16.2 参考游戏

- Mini Metro：河流穿越机制
- 河流将地图分割，线路穿越需要消耗资源
- 穿越次数与消耗成正比

---

*文档结束*
